/*
 *  events.eclipse.org - v0.0.1
 *  The site provides events for the Eclipse ecosystem.
 *
 * Copyright (c) 2013-2016 Angelika Wittek (Munich, Germany).
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *    Angelika Wittek
 *    Ralph Müller (rm)
 *    Christopher Guindon
 */
function initialize(){eventtypeURLParaValue=getURLParameter(eventtypeURLParaName),yearURLParaValue=getURLParameter(yearURLParaName),$.getJSON(jsonDatafile,processData)}function processData(data){document.title=browserTitle,$("#pageTitle").append(pageTitle),allEclipseEvents=data.events;for(var i in allEclipseEvents)allEclipseEvents[i].dateTime=new Date(allEclipseEvents[i].date);allEclipseEvents.sort(compareEventsByRankAndDate);for(var regionId in regionInfos)$("#regionButtons").append("<button id="+regionId+' onClick="regionButtonClicked(this.id)" class="btn btn-default regionButton">'+regionInfos[regionId].name+"</button>");$("#eventsmail1").append('<p class=\"text-right\">Missing your event on this site? Please open a bug on <a href="https://bugs.eclipse.org/bugs/enter_bug.cgi?product=Community&component=events.eclipse.org">Eclipse Bugzilla</a></p>'),$("#eventsmail2").append('<p class=\"text-right\">Missing your event on this site? Please open a bug on <a href="https://bugs.eclipse.org/bugs/enter_bug.cgi?product=Community&component=events.eclipse.org">Eclipse Bugzilla</a></p>');var currentYear=(new Date).getFullYear();createYearButtons(currentYear),initMap(),null!=yearURLParaValue?fillMap(yearURLParaValue,!1):fillMap(currentYear,!0)}function initMap(){map=L.map("map",{center:[regionInfos.world.lat,regionInfos.world.lon],zoom:2,minZoom:2});var baseLayer=initBaseLayer();map.addLayer(baseLayer,!0),layerControl=new L.control.layers(null,null,{position:"bottomright",collapsed:!1,autoZIndex:!0}),layerControl.addTo(map)}function initBaseLayer(){return L.tileLayer("//api.tiles.mapbox.com/v3/ralphmueller.i1lhfh9m/{z}/{x}/{y}.png",{maxZoom:18,attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>'})}function clearMap(){clearDescriptionsArea();for(var i in markerClusterGroups)map.removeLayer(markerClusterGroups[i]),layerControl.removeLayer(markerClusterGroups[i])}function fillMap(year,futureEventsOnly){clearMap(),markerClusterGroups=[];var eclipseEvents=filterEventsByYear(year,futureEventsOnly),markers4Layer=[];for(var i in eclipseEvents){var eventtype=eclipseEvents[i].type;if(eventtype in eventTypeInfo!=0){var texttitle=eclipseEvents[i].title+", "+eclipseEvents[i].dateTime.toDateString(),description=createHtmlDescription(eclipseEvents[i]),marker=createMarker(eclipseEvents[i],texttitle,description);eventtype in markers4Layer==0&&(markers4Layer[eventtype]=[]),markers4Layer[eventtype].push(marker),fillDescriptionsArea(eventtype,texttitle,description,i)}else alert("EventType ["+eventtype+"] from Jsonfile: ["+jsonDatafile+"] is not declared in the eventTypeInfo-Array!")}var eventTypeKeysReverse=new Array;for(var k in eventTypeInfo)eventTypeKeysReverse.unshift(k);for(var c=eventTypeKeysReverse.length,n=0;n<c;n++)if(eventtype=eventTypeKeysReverse[n],void 0!=markers4Layer[eventtype]){var layer=L.layerGroup(markers4Layer[eventtype]),markerClusterGroup=createMarkerClusterGroup();markerClusterGroup.addLayer(layer),null!=eventtypeURLParaValue&&eventtype!==eventtypeURLParaValue||map.addLayer(markerClusterGroup),markerClusterGroups[eventtype]=markerClusterGroup,layerControl.addOverlay(markerClusterGroup,eventTypeInfo[eventtype].name+" <img src='"+eventTypeInfo[eventtype].image_small+"' />")}}function createMarkerClusterGroup(){return new L.MarkerClusterGroup({iconCreateFunction:function(cluster){var markers=cluster.getAllChildMarkers(),thisEventtype=markers[0].options.alt;return new L.DivIcon({iconSize:[0,0],html:'<div class="clusterIcon" style="background:'+eventTypeInfo[thisEventtype].color+'">'+cluster.getChildCount()+"</div>"})}})}function createYearButtons(currentYear){var years=[];for(var i in allEclipseEvents){var year=allEclipseEvents[i].dateTime.getFullYear();if(-1==years.indexOf(year)){if(year!=year){console.log("wrong dateformat for: "+allEclipseEvents[i].title);continue}years.push(year),$("#yearDropDown").append('<li role="presentation"><a id='+year+' role="menuitem" tabindex="-1" href="#eecontent"  onClick="fillMap(this.id, false);return true;"> '+year+" </a></li>")}}$("#yearDropDown").append('<li role="presentation" class="divider"></li>'),$("#yearDropDown").append('<li role="presentation"><a id='+currentYear+' role="menuitem" tabindex="-1" href="#eecontent"  onClick="fillMap(this.id, true);return true;"> upcoming </a></li>')}function clearDescriptionsArea(){null!=document.getElementById("_descriptons")&&$("#_descriptons").remove(),$("#descriptons").append('<div id="_descriptons" ><div>')}function fillDescriptionsArea(eventtype,texttitle,description,index){null==document.getElementById(eventtype)&&$("#_descriptons").append("<div id="+eventtype+' class="eventType"><h3 class="eventTypeTitle"> <img src=\''+eventTypeInfo[eventtype].image_small+"' /> &nbsp;"+eventTypeInfo[eventtype].name+"</h3></div>");var divId=eventtype+index,divIdDescr=getDescrId(divId);$("#"+eventtype).append("<div id="+divId+' onClick="revealCollapse(this.id)" class="revealCollapse" >'+texttitle+"</div>"),$("#"+eventtype).append("<div id="+divIdDescr+' class="collapseText">'+description+"</div>")}function getDescrId(id){return id+"_descr"}function createMarker(event,texttitle,description){var latLon=new L.LatLng(event.address.geoLoc.lat,event.address.geoLoc.lon),marker=new L.marker(latLon,{title:texttitle,alt:event.type}).bindPopup("<b>"+texttitle+"</b><br>"+description);return marker.setIcon(getEventIcon(event.type)),marker}function filterEventsByYear(year,futureEventsOnly){var events=[];for(var i in allEclipseEvents)futureEventsOnly?isFutureEvent(allEclipseEvents[i].dateTime)&&events.push(allEclipseEvents[i]):allEclipseEvents[i].dateTime.getFullYear()==year&&events.push(allEclipseEvents[i]);return events}function getEventIcon(type){var xSize=eventTypeInfo[type].icon_size.x,ySize=eventTypeInfo[type].icon_size.y,xAnchor=xSize/2,yAnchor=ySize-1,EclipseIcon=L.Icon.extend({options:{iconSize:[xSize,ySize],iconAnchor:[xAnchor,yAnchor],popupAnchor:[-3,-76]}});return type in eventIcons==0&&(eventIcons[type]=new EclipseIcon({iconUrl:eventTypeInfo[type].image})),eventIcons[type]}function createHtmlDescription(eclipseEvent){var d;return d="<span>",d+="<p>"+eclipseEvent.description+"</p>",d+="<p>",void 0!=eclipseEvent.company&&(d+="<p>Company Name: ",d+=eclipseEvent.company+"</p>"),d+="Address:<br>",d+=eclipseEvent.locationName+"<br>",d+=eclipseEvent.address.street+", ",d+=eclipseEvent.address.zip+" "+eclipseEvent.address.city+", "+eclipseEvent.address.country,d+="</p>",d+="<p>",null!=eclipseEvent.infoLink&&""!=eclipseEvent.infoLink.trim()?d+="<a href="+eclipseEvent.infoLink+" target=_blank> more information</a>":d+="<span style='font-weight: bold; color: gray;'>more information</span>",d+="&nbsp;&nbsp;&nbsp;&nbsp;",null!=eclipseEvent.registration&&""!=eclipseEvent.registration.trim()&&(d+="<a href="+eclipseEvent.registration+" target=_blank> register here</a>",d+="&nbsp;&nbsp;&nbsp;&nbsp;"),d+='<a href="#" onclick="showEventOnMap(\''+eclipseEvent.type+"',"+eclipseEvent.address.geoLoc.lat+","+eclipseEvent.address.geoLoc.lon+');"> show on map</a>',d+="</span>"}function revealCollapse(id){var textId=getDescrId(id);"block"==document.getElementById(textId).style.display?document.getElementById(textId).style.display="none":document.getElementById(textId).style.display="block"}function regionButtonClicked(buttonId){var latLon=new L.LatLng(regionInfos[buttonId].lat,regionInfos[buttonId].lon),zoom=regionInfos[buttonId].zoom;map.setView(latLon,zoom)}function showEventOnMap(eventtype,lat,lon){var markerClusterGroup=markerClusterGroups[eventtype];map.addLayer(markerClusterGroup);var latLon=new L.LatLng(lat,lon);map.setView(latLon,15)}function isFutureEvent(d){var localMorning=new Date;return localMorning.setHours(0),localMorning.setMinutes(0),localMorning.setSeconds(0),localMorning.setMilliseconds(0),localMorning<=d}function compareEventsByRankAndDate(e1,e2){return eventTypeInfo[e1.type].rank<eventTypeInfo[e2.type].rank?-1:eventTypeInfo[e1.type].rank>eventTypeInfo[e2.type].rank?1:compareDates(e1.dateTime,e2.dateTime)}function compareDates(d1,d2){return d1-d2}function getURLParameter(name){return decodeURIComponent((new RegExp("[?|&]"+name+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null}var map,eventIcons=[],allEclipseEvents,markerClusterGroups=[],layerControl,eventtypeURLParaValue,yearURLParaValue,browserTitle="Eclipse Events",pageTitle="Upcoming Eclipse Events",jsonDatafile="data/EclipseEvents.json",eventtypeURLParaName="eventtype",yearURLParaName="year",eventTypeInfo={ec:{rank:1,name:"EclipseCons",image:"images/marker-icon-red.png",image_small:"images/small-marker-icon-red.png",color:"#D93333",icon_size:{x:"25",y:"41"}},dc:{rank:2,name:"Demo Camps & Stammtisch",image:"images/marker-icon-green.png",image_small:"images/small-marker-icon-green.png",color:"#6AAA16",icon_size:{x:"25",y:"41"}},ed:{rank:3,name:"Eclipse Days & Hackathons",image:"images/marker-icon-yellow.png",image_small:"images/small-marker-icon-yellow.png",color:"#CEA70A",icon_size:{x:"25",y:"41"}},wg:{rank:4,name:"Working Group Events",image:"images/marker-icon-blue.png",image_small:"images/small-marker-icon-blue.png",color:"#2B82CB",icon_size:{x:"25",y:"41"}},et:{rank:5,name:"Training Series",image:"images/marker-icon-cyan.png",image_small:"images/small-marker-icon-cyan.png",color:"#14C6AB",icon_size:{x:"25",y:"41"}},ee:{rank:6,name:"Other interesting Events",image:"images/marker-icon-purple.png",image_small:"images/small-marker-icon-purple.png",color:"#9B3CB5",icon_size:{x:"25",y:"41"}},unknown:{name:"unknown",image:"images/marker-icon-gray.png",image_small:"images/small-marker-icon.png",color:"grey",icon_size:{x:"25",y:"41"}}},regionInfos={world:{name:"World",lat:"20.71859",lon:"40.44922",zoom:"2"},ap:{name:"Asia",lat:"40.17887",lon:"101.68945",zoom:"3"},au:{name:"Australia",lat:"-23.838315",lon:"151.208503",zoom:"3"},emea:{name:"Europe",lat:"53.3758916",lon:"9.7320104",zoom:"4"},na:{name:"North America",lat:"40.71396",lon:"-94.08691",zoom:"4"},de:{name:"Germany",lat:"51.1599007",lon:"10.4429998",zoom:"6"},fr:{name:"France",lat:"46.768196",lon:"2.432664",zoom:"6"}};